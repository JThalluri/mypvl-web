name: Deploy to GitHub Pages - SAFE

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source (main branch)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Checkout AND PRESERVE gh-pages branch
        uses: actions/checkout@v3
        with:
          ref: gh-pages
          path: gh-pages-target

      - name: Copy website files (non-destructive)
        run: |
          echo "=== SAFELY COPYING FILES ==="
          echo "Current gh-pages content:"
          ls -la gh-pages-target/
          
          # Copy main site files
          cp -f index.html gh-pages-target/index.html
          echo "✅ Updated index.html"
          
          # Copy all policy pages
          cp -f privacy_policy.html gh-pages-target/
          cp -f cookies_policy.html gh-pages-target/
          cp -f terms_of_use.html gh-pages-target/
          cp -f thirdparty_attributions.html gh-pages-target/
          cp -f contact_us.html gh-pages-target/
          cp -f dmca_policy.html gh-pages-target/
          cp -f wrapper.html gh-pages-target/
          cp -f manifest.json gh-pages-target/
          cp -f sw.js gh-pages-target/
          echo "✅ Updated policy pages"
          
          # Remove and replace ONLY the resources folder
          rm -rf gh-pages-target/resources
          rm -rf gh-pages-target/css  # Remove old css if exists
          rm -rf gh-pages-target/js  # Remove old js if exists
          rm -rf gh-pages-target/library  # Remove old library file if exists
          rm -rf gh-pages-target/icons
          cp -r resources gh-pages-target/
          cp -r css gh-pages-target/  # Add css folder for policy pages and wpa
          cp -r js gh-pages-target/  # Add js folder for policy pages and wpa
          cp -r library gh-pages-target/  # Add library folder for wpa
          cp -r icons gh-pages-target/
          echo "✅ Updated resources and css folders"
          
          echo "Final gh-pages content:"
          ls -la gh-pages-target/

      - name: Commit and push website files
        run: |
          cd gh-pages-target
          
          # Set Git identity for THIS repository
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add ALL website files we explicitly changed
          git add index.html
          git add privacy_policy.html
          git add cookies_policy.html
          git add terms_of_use.html
          git add thirdparty_attributions.html
          git add contact_us.html
          git add dmca_policy.html
          git add wrapper.html
          git add sw.js
          git add manifest.json
          git add resources/
          git add css/
          git add icons/ 
          git add js/
          git add library/
          
          echo "=== FILES BEING COMMITTED ==="
          git status --short
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update website: main site, policy pages, and assets [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push origin gh-pages
            echo "✅ Successfully updated website files"
          fi

      - name: Verify preservation
        run: |
          cd gh-pages-target
          echo "=== FINAL VERIFICATION ==="
          echo "All files in gh-pages after deployment:"
          find . -type f -not -path "./.git/*" | sort