name: Deploy to gh-pages (Safe Merge from deploy/)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-target

      - name: Merge-copy deploy artifacts (non-destructive)
        run: |
          set -euo pipefail

          SOURCE_DIR="deploy"
          TARGET_DIR="gh-pages-target"

          if [ ! -d "$SOURCE_DIR" ]; then
            echo "Expected build output '$SOURCE_DIR' not found"
            exit 1
          fi

          echo "=== Copying root HTML pages and manifest ==="
          shopt -s nullglob
          for file in "$SOURCE_DIR"/*.html "$SOURCE_DIR"/manifest.json; do
            if [ -f "$file" ]; then
              cp -f "$file" "$TARGET_DIR/$(basename "$file")"
              echo "Updated $(basename "$file")"
            fi
          done

          echo "=== Merging shared folders without deleting existing tenant content ==="
          for folder in assets shared icons resources css js library framework; do
            if [ -d "$SOURCE_DIR/$folder" ]; then
              mkdir -p "$TARGET_DIR/$folder"
              rsync -a "$SOURCE_DIR/$folder/" "$TARGET_DIR/$folder/"
              echo "Merged $folder/ from $SOURCE_DIR"
            fi
          done

          echo "=== Merging repo-level shared files when present ==="
          if [ -d ".well-known" ]; then
            mkdir -p "$TARGET_DIR/.well-known"
            rsync -a ".well-known/" "$TARGET_DIR/.well-known/"
            echo "Merged .well-known/"
          fi

          if [ -f "sw.js" ]; then
            cp -f "sw.js" "$TARGET_DIR/sw.js"
            echo "Updated sw.js"
          fi

          if [ -f "wrapper.html" ]; then
            cp -f "wrapper.html" "$TARGET_DIR/wrapper.html"
            echo "Updated wrapper.html"
          fi

          echo "=== Safety check: tenant folders still present ==="
          ls -1 "$TARGET_DIR" | head -n 50

      - name: Commit and push deployment changes
        run: |
          set -euo pipefail
          cd gh-pages-target

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage only known site/root/shared paths; do not blanket-add repository.
          for path in \
            index.html \
            privacy_policy.html \
            cookies_policy.html \
            terms_of_use.html \
            thirdparty_attributions.html \
            contact_us.html \
            dmca_policy.html \
            manifest.json \
            wrapper.html \
            sw.js \
            assets \
            shared \
            icons \
            resources \
            css \
            js \
            library \
            framework \
            .well-known
          do
            if [ -e "$path" ]; then
              git add -A "$path"
            fi
          done

          echo "=== Candidate changes ==="
          git status --short

          if git diff --staged --quiet; then
            echo "No deployment changes to commit"
            exit 0
          fi

          git commit -m "Deploy site update (safe merge) [$(date +'%Y-%m-%d %H:%M:%S')]"
          git push origin gh-pages

      - name: Post-deploy verification
        run: |
          cd gh-pages-target
          echo "=== Deployed files (sample) ==="
          find . -maxdepth 3 -type f | sort | head -n 200
